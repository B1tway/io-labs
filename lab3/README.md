# Лабораторная работа 3

**Название:** "Разработка драйверов сетевых устройств"

**Цель работы:** получить знания и навыки разработки драйверов сетевых интерфейсов для операционной системы Linux

## Описание функциональности драйвера

Данный драйвер надстраивается над интерфейсом указанным в `link` и анализирует принимаемые и отправляемые пакеты, которые затем возвращает далее интерфейсу ниже.

Анализ пакетов заключается в том, что подсчитываем статистику только по IP пакетам версии 4, и которые отправляются на определенный IP адрес, указанный в `destipv4`.

Информацию о своей работе модуль пишет в кольцевой буфер ядра.

## Инструкция по сборке

1. `make` -- собрать исходные файлы в динамически-загружаемый модуль
2. `sudo make do` -- загрузить модуль с параметрами по умолчанию
    + `sudo insmod virt_net_if.ko link=<название надстраиваемого интерфейса> destipv4=<прослушиваемый адрес получателя>` -- загрузить  модуль с пользовательскими параметрами

## Инструкция пользователя

1. Собрать драйвер и загрузить в ядро ( [см. Инструкцию по сборке](#инструкция-по-сборке) )
2. Изредка просматривать кольцевой буфер ядра на наличие ошибок или на содержимое захваченных пакетов
3. Можно проверять статистику работы интерфейса с помощью `ifconfig vni0`

## Примеры использования

```
make
sudo insmod virt_net_if.ko destipv4=192.168.31.9
...
ifconfig vni0
```
---
```
[ 5223.483070] Checking Frame: Protocol: 800, Version: 4, daddr: 35.224.170.84, listening daddr: 192.168.31.9
[ 5223.483103] Checking Frame: Protocol: 800, Version: 4, daddr: 35.224.170.84, listening daddr: 192.168.31.9
[ 5223.483168] Checking Frame: Protocol: 800, Version: 4, daddr: 192.168.31.9, listening daddr: 192.168.31.9
[ 5223.483173] Captured IPv4 packet, saddr: 35.224.170.84; daddr: 192.168.31.9
[ 5223.483175] Data length: 32:
[ 5223.483181] Checking Frame: Protocol: 800, Version: 4, daddr: 35.224.170.84, listening daddr: 192.168.31.9
[ 5223.558089] Checking Frame: Protocol: 800, Version: 4, daddr: 192.168.31.240, listening daddr: 192.168.31.9
[ 5223.619776] Checking Frame: Protocol: 800, Version: 4, daddr: 192.168.31.9, listening daddr: 192.168.31.9
[ 5223.619798] Captured IPv4 packet, saddr: 35.224.170.84; daddr: 192.168.31.9
...
vni0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.31.9  netmask 255.255.255.0  broadcast 192.168.31.255
        inet6 fe80::c108:a9ed:c621:9372  prefixlen 64  scopeid 0x20<link>
        ether f0:2f:74:b0:6d:a8  txqueuelen 1000  (Ethernet)
        RX packets 162  bytes 40732 (40.7 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

```
cat /proc/var2
---
saddr: 64.233.165.101
saddr: 64.233.165.101
saddr: 173.194.222.188
saddr: 64.233.165.101
saddr: 64.233.165.101
saddr: 64.233.165.101
saddr: 64.233.165.101
saddr: 192.168.31.1
saddr: 192.168.31.1
saddr: 192.168.31.1
saddr: 192.168.31.1
saddr: 192.168.31.1
saddr: 192.168.31.1

```
